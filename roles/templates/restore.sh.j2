#!/bin/bash

source_url='{{ source_url }}'
domain='{{ domain }}'


path="`find /home -name "$domain"`/public_html"
user=`find /home -name "$domain" | awk -F '/' '{print $3}'`

wp_user=`cat $path/public_html/wp-config.php | grep 'DB_USER' | awk -F',' '{print $2}' | cut -c 3- | rev | cut -c 4- | rev`
wp_data_name=`cat $path/public_html/wp-config.php | grep 'DB_NAME' | awk -F',' '{print $2}' | cut -c 3- | rev | cut -c 4- | rev`
wp_pass=`cat $path/public_html/wp-config.php | grep 'DB_PASSWORD' | awk -F',' '{print $2}' | cut -c 3- | rev | cut -c 4- | rev`

cd $path/public_html/
sudo mv wp-config.php $path

sudo rm -rf $path/public_html/*

wget $source_url

sudo unzip *.zip

sudo mysql $wp_data_name < *.sql

sed -i "s/'DB_NAME', .*/'DB_NAME', '${wp_data_name}');/g" wp-config.php
sed -i "s/'DB_USER', .*/'DB_USER', '${wp_user}');/g" wp-config.php
sed -i "s/'DB_PASSWORD', .*/'DB_PASSWORD', '${wp_pass}');/g" wp-config.php

sudo chown $user:$user -R *

cd $path/wp-content/
rm -rf advanced-cache.php cache wp-rocket-config